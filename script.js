'use strict';

document.addEventListener('DOMContentLoaded', () => {

    // --- Element References ---
    const loadingErrorDiv = document.getElementById('loading-error-message');
    const shopTabsContainer = document.getElementById('shop-tabs-container');
    const addTabButton = document.getElementById('add-tab-btn');
    const newShopInputContainer = document.getElementById('new-shop-input-container');
    const newShopNameInput = document.getElementById('new-shop-name-input');
    const saveNewShopButton = document.getElementById('save-new-shop-btn');
    const cancelNewShopButton = document.getElementById('cancel-new-shop-btn');
    const tabContentArea = document.getElementById('tab-content-area');
    const noShopPlaceholder = document.getElementById('no-shop-placeholder');
    const overallSummaryContainer = document.getElementById('overall-summary-container');
    const overallSummaryButton = document.getElementById('overall-summary-btn');
    const summaryModal = document.getElementById('summaryModal');
    const summaryContent = document.getElementById('summaryContent');
    const summaryTimestampElem = document.getElementById('summary-timestamp');
    const copyStatus = document.getElementById('copy-status');
    const modalActionsDiv = summaryModal?.querySelector('.modal-actions'); // V18: ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° Save ‡πÅ‡∏•‡πâ‡∏ß
    const modalCloseButton = document.getElementById('modal-close-btn');
    const copySummaryButton = document.getElementById('copy-summary-btn');
    const closeModalActionButton = document.getElementById('close-modal-action-btn');

    // --- Constants ---
    const BASE_UNITS = ["‡∏Å‡∏Å.", "‡∏Å‡∏£‡∏±‡∏°", "‡∏Ç‡∏µ‡∏î", "‡∏Å‡∏•‡πà‡∏≠‡∏á", "‡∏Å‡∏≥", "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á", "‡∏Ç‡∏ß‡∏î", "‡∏Ç‡∏∂‡πâ‡∏ô‡∏â‡πà‡∏≤‡∏¢", "‡∏ä‡∏∏‡∏î", "‡∏ä‡∏¥‡πâ‡∏ô", "‡∏ä‡πà‡∏≠", "‡∏ã‡∏≠‡∏á", "‡∏ï‡πâ‡∏ô", "‡∏ñ‡∏∏‡∏á", "‡πÅ‡∏ú‡πà‡∏ô", "‡πÅ‡∏ú‡∏á", "‡πÅ‡∏ñ‡∏ß", "‡∏ú‡∏•", "‡πÉ‡∏ö", "‡∏õ‡∏µ‡πä‡∏ö", "‡∏û‡∏ß‡∏á", "‡πÅ‡∏û‡πá‡∏Ñ", "‡∏ü‡∏≠‡∏á", "‡∏°‡πâ‡∏ß‡∏ô", "‡∏°‡∏±‡∏î", "‡πÄ‡∏°‡∏ï‡∏£", "‡∏•‡∏±‡∏á", "‡∏•‡∏π‡∏Å", "‡πÄ‡∏™‡πâ‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢", "‡∏≠‡∏±‡∏ô", "‡∏´‡∏±‡∏ß", "‡∏´‡∏ß‡∏µ", "‡πÇ‡∏´‡∏•"].sort((a, b) => a.localeCompare(b, 'th'));
    const GLOBAL_ITEMS_DATALIST_ID = 'global-items-list';
    const GLOBAL_UNITS_DATALIST_ID = 'global-units-list';
    const ITEMS_JSON_PATH = 'items.json';
    // const SAVE_CHANGES_BTN_ID = 'save-summary-changes-btn'; // V18: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß

    // --- State Variables ---
    let masterItemList = [];
    let shops = [];
    let activeShopId = null;
    let summaryModalShopId = null; // V18: ‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î modal
    // let hasUnsavedChanges = false; // V18: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ flag ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏Å‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å

    // V18: ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17)
    const initialShopsData = [
         { id: `shop-init-${Date.now()+1}`, name: '‡∏ô‡πâ‡∏≤‡πÑ‡∏ù', items: [] },
         { id: `shop-init-${Date.now()+2}`, name: '‡∏ô‡πâ‡∏≤‡πÑ‡∏û', items: [] },
         { id: `shop-init-${Date.now()+3}`, name: '‡∏ô‡πâ‡∏≤‡∏£‡∏∏‡πà‡∏á', items: [] },
    ];

    // --- V18: Rendering Functions ---

    /** V18: ‡∏ß‡∏≤‡∏î‡πÅ‡∏ñ‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17) */
    function renderTabs() {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V17.1)
        console.log("renderTabs called. ActiveShopId:", activeShopId); if (!shopTabsContainer || !addTabButton) { console.error("renderTabs: Missing elements"); return; } const previouslyFocusedElement = document.activeElement; Array.from(shopTabsContainer.children).forEach(child => { if (child !== addTabButton && child !== newShopInputContainer) { shopTabsContainer.removeChild(child); } });
        shops.forEach(shop => { const tabButton = document.createElement('button'); tabButton.className = 'tab-button'; tabButton.dataset.shopId = shop.id; const tabNameSpan = document.createElement('span'); tabNameSpan.className = 'tab-name'; tabNameSpan.textContent = shop.name; const deleteTabBtn = document.createElement('button'); deleteTabBtn.className = 'delete-tab-btn'; deleteTabBtn.innerHTML = '&times;'; deleteTabBtn.title = `‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô ${shop.name}`; deleteTabBtn.dataset.shopId = shop.id; tabButton.appendChild(tabNameSpan); tabButton.appendChild(deleteTabBtn); if (shop.id === activeShopId) { tabButton.classList.add('active'); } tabButton.addEventListener('click', handleTabClick); shopTabsContainer.insertBefore(tabButton, addTabButton); });
        if (document.body.contains(previouslyFocusedElement)) { try { previouslyFocusedElement.focus({ preventScroll: true }); } catch (e) {} } else if (activeShopId) { const activeTabButton = shopTabsContainer.querySelector(`.tab-button[data-shop-id="${activeShopId}"]`); activeTabButton?.focus({ preventScroll: true }); } updateOverallSummaryButtonVisibility();
    }

    /** V18: ‡∏ß‡∏≤‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17) */
    function renderTabContent() {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V17.1 - ‡∏™‡∏£‡πâ‡∏≤‡∏á header, entry area, list area, actions)
        console.log("renderTabContent called. ActiveShopId:", activeShopId); if (!tabContentArea) { console.error("renderTabContent: Missing tabContentArea"); return; } tabContentArea.innerHTML = ''; const activeShop = shops.find(shop => shop.id === activeShopId);
        if (activeShop) { console.log("Rendering content for shop:", activeShop.name); const headerDiv = document.createElement('div'); headerDiv.className = 'shop-header'; const shopNameDisplay = document.createElement('span'); shopNameDisplay.className = 'shop-name-display'; shopNameDisplay.textContent = activeShop.name; headerDiv.appendChild(shopNameDisplay); tabContentArea.appendChild(headerDiv); const entryArea = createItemEntryArea(activeShop.id); tabContentArea.appendChild(entryArea); const itemListArea = document.createElement('div'); itemListArea.className = 'item-list-area'; itemListArea.id = `item-list-${activeShop.id}`; const ul = document.createElement('ul'); if (activeShop.items.length > 0) { activeShop.items.forEach((item, index) => { ul.appendChild(createShopItemRow(activeShop.id, item, index)); }); } else { ul.innerHTML = '<li class="item-list-placeholder">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ...</li>'; } itemListArea.appendChild(ul); tabContentArea.appendChild(itemListArea); const buttonsDiv = document.createElement('div'); buttonsDiv.className = 'shop-actions'; const summarizeBtn = document.createElement('button'); summarizeBtn.textContent = 'üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ'; summarizeBtn.className = 'action-button summarize-btn'; summarizeBtn.type = "button"; summarizeBtn.addEventListener('click', () => showSummary(activeShopId)); buttonsDiv.appendChild(summarizeBtn); tabContentArea.appendChild(buttonsDiv); if(noShopPlaceholder) noShopPlaceholder.style.display = 'none'; }
        else { console.log("No active shop, showing placeholder."); if(noShopPlaceholder) noShopPlaceholder.style.display = 'block'; }
    }

    /** V18: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô List Area (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Edit) */
    function createShopItemRow(shopId, itemData, index) {
        const li = document.createElement('li');
        li.className = 'shop-item-row';
        li.dataset.shopId = shopId;
        li.dataset.itemIndex = index;

        // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Display Mode) - ‡∏™‡∏£‡πâ‡∏≤‡∏á span ‡∏ï‡πà‡∏≤‡∏á‡πÜ
        const displayDiv = document.createElement('div');
        displayDiv.className = 'item-display-mode'; // Div ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•

        const quantitySpan = document.createElement('span');
        quantitySpan.className = 'item-quantity';
        quantitySpan.textContent = itemData.quantity;

        const unitSpan = document.createElement('span');
        unitSpan.className = 'item-unit';
        unitSpan.textContent = itemData.unit || '?';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'item-name';
        nameSpan.textContent = itemData.item;

        const actionButtonsDiv = document.createElement('div'); // Div ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏° Edit/Delete
        actionButtonsDiv.className = 'item-actions-display';

        // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏î‡∏¥‡∏ô‡∏™‡∏≠)
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-item-inline-btn'; // Class ‡πÉ‡∏´‡∏°‡πà
        editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><line x1="18" y1="2" x2="22" y2="6"/><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"/></svg>`;
        editBtn.title = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${itemData.item}`;

        // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞)
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-item-inline-btn'; // Class ‡πÄ‡∏î‡∏¥‡∏°
        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;
        deleteBtn.title = `‡∏•‡∏ö ${itemData.item}`;

        actionButtonsDiv.appendChild(editBtn);
        actionButtonsDiv.appendChild(deleteBtn);

        displayDiv.appendChild(quantitySpan);
        displayDiv.appendChild(unitSpan);
        displayDiv.appendChild(nameSpan);
        displayDiv.appendChild(actionButtonsDiv); // ‡πÄ‡∏û‡∏¥‡πà‡∏° div ‡∏õ‡∏∏‡πà‡∏° action

        // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit Mode) - ‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
        const editDiv = document.createElement('div');
        editDiv.className = 'item-edit-mode hidden'; // ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ class 'hidden'

        const editQuantityInput = document.createElement('input');
        editQuantityInput.type = 'number';
        editQuantityInput.className = 'edit-quantity-inline';
        editQuantityInput.value = itemData.quantity;
        editQuantityInput.min = "0"; editQuantityInput.step = "any";

        const editUnitInput = document.createElement('input');
        editUnitInput.type = 'text';
        editUnitInput.className = 'edit-unit-inline';
        editUnitInput.value = itemData.unit || '';
        editUnitInput.setAttribute('list', GLOBAL_UNITS_DATALIST_ID);

        // ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô text ‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô)
        const editNameSpan = document.createElement('span');
        editNameSpan.className = 'item-name-edit-display'; // Class ‡πÉ‡∏´‡∏°‡πà
        editNameSpan.textContent = itemData.item;

        const editActionButtonsDiv = document.createElement('div'); // Div ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏° Save/Cancel
        editActionButtonsDiv.className = 'item-actions-edit';

        // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å)
        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-edit-inline-btn';
        saveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><polyline points="20 6 9 17 4 12"/></svg>`;
        saveBtn.title = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';

        // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó)
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'cancel-edit-inline-btn';
        cancelBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
        cancelBtn.title = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';

        editActionButtonsDiv.appendChild(saveBtn);
        editActionButtonsDiv.appendChild(cancelBtn);

        editDiv.appendChild(editQuantityInput);
        editDiv.appendChild(editUnitInput);
        editDiv.appendChild(editNameSpan); // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏¢‡πÜ
        editDiv.appendChild(editActionButtonsDiv);

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô li
        li.appendChild(displayDiv);
        li.appendChild(editDiv);

        return li;
    }


    // --- UI Creation Functions (‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    function createOrUpdateDatalist(listId, optionsArray) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        let datalist = document.getElementById(listId); if (!datalist) { datalist = document.createElement('datalist'); datalist.id = listId; document.body.appendChild(datalist); datalist = document.getElementById(listId); if (!datalist) { console.error(`!!! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏´‡∏≤ datalist ID: ${listId} ‡πÑ‡∏î‡πâ!`); return; } } datalist.innerHTML = ''; if (!Array.isArray(optionsArray)) { console.error(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö datalist ID: ${listId} ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array!`); return; } const sortedOptions = [...optionsArray].sort((a, b) => a.localeCompare(b, 'th')); sortedOptions.forEach(optionValue => { if (typeof optionValue === 'string' && optionValue.trim() !== '') { try { const option = document.createElement('option'); option.value = optionValue; datalist.appendChild(option); } catch (e) { console.error(`‡πÄ‡∏Å‡∏¥‡∏î Error ‡∏ï‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° option "${optionValue}" ‡πÉ‡∏ô datalist ID: ${listId}`, e); } } });
    }
    function createUnitInputEntry(selectedUnit = '') { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        const input = document.createElement('input'); input.type = 'text'; input.placeholder = '‡∏´‡∏ô‡πà‡∏ß‡∏¢'; input.className = 'entry-unit'; input.value = selectedUnit; input.setAttribute('list', GLOBAL_UNITS_DATALIST_ID); return input;
    }
    function createItemInputEntry(selectedItem = '') { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        const input = document.createElement('input'); input.type = 'text'; input.placeholder = '‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°...'; input.className = 'entry-item'; input.value = selectedItem; input.setAttribute('list', GLOBAL_ITEMS_DATALIST_ID); return input;
    }
    function createItemEntryArea(shopId) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° - SVG included) */
        const entryDiv = document.createElement('div'); entryDiv.className = 'item-entry-area'; entryDiv.dataset.shopId = shopId;
        const quantityInput = document.createElement('input'); quantityInput.type = 'number'; quantityInput.placeholder = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'; quantityInput.min = "0"; quantityInput.step = "any"; quantityInput.className = 'entry-quantity';
        const unitInput = createUnitInputEntry(); const itemInput = createItemInputEntry();
        const addBtn = document.createElement('button'); addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>`; addBtn.className = 'action-button entry-add-btn'; addBtn.title = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ"; addBtn.type = "button";
        const statusDiv = document.createElement('div'); statusDiv.className = 'entry-status';
        entryDiv.appendChild(quantityInput); entryDiv.appendChild(unitInput); entryDiv.appendChild(itemInput); entryDiv.appendChild(addBtn); entryDiv.appendChild(statusDiv); return entryDiv;
    }

    // --- V18: Event Handlers ---

    /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17) */
    function handleTabClick(event) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V17.1) */
        if (event.target.closest('.delete-tab-btn')) { event.stopPropagation(); return; } const clickedTab = event.target.closest('.tab-button'); if (!clickedTab || clickedTab.classList.contains('active')) { return; } const newActiveShopId = clickedTab.dataset.shopId; console.log("Tab selected:", newActiveShopId); if (newActiveShopId) { activeShopId = newActiveShopId; renderTabs(); renderTabContent(); }
    }
    /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà */
    function handleAddTabClick() { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        console.log("Add tab button clicked"); if (newShopInputContainer && addTabButton && newShopNameInput) { newShopInputContainer.classList.remove('hidden'); addTabButton.classList.add('hidden'); newShopNameInput.value = ''; newShopNameInput.focus(); console.log("Showing new shop input"); } else { console.error("handleAddTabClick: Missing required elements"); }
    }
    /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà */
    function handleCancelNewShop() { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        console.log("Cancel new shop"); if (newShopInputContainer && addTabButton) { newShopInputContainer.classList.add('hidden'); addTabButton.classList.remove('hidden'); newShopNameInput.value = ''; } else { console.error("handleCancelNewShop: Missing required elements"); }
    }
    /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà */
    function handleSaveNewShop() { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        console.log("Save new shop clicked"); if (!newShopNameInput) { console.error("handleSaveNewShop: Missing newShopNameInput"); return; } const newName = newShopNameInput.value.trim(); if (!newName) { alert("‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏ô‡∏∞"); newShopNameInput.focus(); return; } if (shops.some(shop => shop.name.toLowerCase() === newName.toLowerCase())) { alert(`‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠ "${newName}" ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞`); newShopNameInput.focus(); newShopNameInput.select(); return; } const newShopId = `shop-${Date.now()}`; const newShopData = { id: newShopId, name: newName, items: [] }; shops.push(newShopData); activeShopId = newShopId; console.log("New shop added:", newShopData); renderTabs(); renderTabContent(); handleCancelNewShop(); /* TODO: Save state */
    }
     /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô (X ‡∏ö‡∏ô‡πÅ‡∏ó‡πá‡∏ö) (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17) */
    function handleDeleteShopClick(event) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V17.1) */
        const deleteButton = event.target.closest('.delete-tab-btn'); if (!deleteButton) return; const shopIdToDelete = deleteButton.dataset.shopId; const shopToDelete = shops.find(s => s.id === shopIdToDelete); console.log("Delete tab button clicked for:", shopIdToDelete, shopToDelete?.name); if (!shopToDelete) return; if (confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏∞‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô "${shopToDelete.name}" ‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏¥? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏´‡∏°‡∏î‡∏ô‡∏∞!`)) { const indexToDelete = shops.findIndex(s => s.id === shopIdToDelete); if (indexToDelete > -1) { shops.splice(indexToDelete, 1); console.log("Shop removed from state."); if (activeShopId === shopIdToDelete) { if (shops.length === 0) { activeShopId = null; } else if (indexToDelete >= shops.length) { activeShopId = shops[shops.length - 1].id; } else { activeShopId = shops[indexToDelete].id; } console.log("New activeShopId:", activeShopId); } renderTabs(); renderTabContent(); /* TODO: Save state */ } }
    }
    /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" (+) ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17) */
    function handleAddItemClick(event) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V17.1) */
        const addButton = event.target.closest('.entry-add-btn'); if (!addButton) return; const entryArea = addButton.closest('.item-entry-area'); if (!entryArea) return; const shopId = entryArea.dataset.shopId; const quantityInput = entryArea.querySelector('.entry-quantity'); const unitInput = entryArea.querySelector('.entry-unit'); const itemInput = entryArea.querySelector('.entry-item'); if (!shopId || !quantityInput || !unitInput || !itemInput) { console.error("‡∏´‡∏≤ elements ‡πÉ‡∏ô entry area ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏£‡πâ‡∏≤‡∏ô:", shopId); return; } const quantity = quantityInput.value.trim(); const unit = unitInput.value.trim(); const itemName = itemInput.value.trim(); const itemNameLower = itemName.toLowerCase(); console.log(`Add item attempt: Qty=${quantity}, Unit=${unit}, Item=${itemName}, Shop=${shopId}`); if (!itemName) { showEntryStatus(entryArea, '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô!', true); itemInput.focus(); return; } if (!quantity) { showEntryStatus(entryArea, '‚ö†Ô∏è ‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤?', true); quantityInput.focus(); return; } const shop = shops.find(s => s.id === shopId); if (!shop) { console.error("‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô state ID:", shopId); showEntryStatus(entryArea, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ', true); return; } const isDuplicate = shop.items.some(item => item.item.toLowerCase() === itemNameLower); if (isDuplicate) { console.log("Duplicate item found:", itemName); showEntryStatus(entryArea, `‚ö†Ô∏è "${itemName}" ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!`, true); itemInput.focus(); itemInput.select(); return; } const newItem = { quantity: quantity, unit: unit || '?', item: itemName }; shop.items.push(newItem); const newItemIndex = shop.items.length - 1; console.log("Item added to state:", shop.items); const listAreaUl = tabContentArea.querySelector(`#item-list-${shopId} ul`); if (listAreaUl) { const placeholder = listAreaUl.querySelector('.item-list-placeholder'); placeholder?.remove(); const newItemRow = createShopItemRow(shopId, newItem, newItemIndex); listAreaUl.appendChild(newItemRow); listAreaUl.parentElement.scrollTop = listAreaUl.parentElement.scrollHeight; } else { console.error("Could not find list area UL for shop:", shopId); renderTabContent(); } showEntryStatus(entryArea, `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° "${itemName}" ‡πÅ‡∏•‡πâ‡∏ß!`, false); quantityInput.value = ''; unitInput.value = ''; itemInput.value = ''; itemInput.focus(); /* TODO: Save state */
    }
     /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞) ‡πÉ‡∏ô List Area (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17) */
    function handleDeleteItemInline(event) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V17.1) */
        const deleteButton = event.target.closest('.delete-item-inline-btn'); if (!deleteButton) return; const tableRow = deleteButton.closest('.shop-item-row'); if (!tableRow) return; const shopId = tableRow.dataset.shopId; const itemIndex = parseInt(tableRow.dataset.itemIndex, 10); if (shopId === undefined || isNaN(itemIndex)) { console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤ shopId ‡∏´‡∏£‡∏∑‡∏≠ itemIndex ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö inline ‡πÑ‡∏î‡πâ"); return; } const shop = shops.find(s => s.id === shopId); if (!shop || !shop.items || itemIndex < 0 || itemIndex >= shop.items.length) { console.error("‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö inline ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠:", shopId, itemIndex); return; } const itemToDelete = shop.items[itemIndex]; if (confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${itemToDelete.item}" (${itemToDelete.quantity} ${itemToDelete.unit}) ‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏¥?`)) { shop.items.splice(itemIndex, 1); console.log("Item deleted inline from state."); /* TODO: Save state */ renderTabContent(); const entryArea = tabContentArea.querySelector(`.item-entry-area[data-shop-id="${shopId}"]`); if (entryArea) { showEntryStatus(entryArea, `üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${itemToDelete.item}" ‡πÅ‡∏•‡πâ‡∏ß`, false); } }
    }
    /** V18: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏ã‡πâ‡∏≥ ‡πÉ‡∏ô Entry Area */
    function showEntryStatus(entryAreaElement, message, isError = false) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        const statusDiv = entryAreaElement?.querySelector('.entry-status'); if (!statusDiv) return; statusDiv.textContent = message; statusDiv.className = `entry-status ${isError ? 'error' : 'success'}`; statusDiv.style.display = 'block'; setTimeout(() => { statusDiv.style.display = 'none'; statusDiv.textContent = ''; statusDiv.className = 'entry-status'; }, 2500);
    }

    /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏î‡∏¥‡∏ô‡∏™‡∏≠) ‡πÉ‡∏ô List Area */
    function handleEditItemInline(event) {
        const editButton = event.target.closest('.edit-item-inline-btn');
        if (!editButton) return;

        const itemRow = editButton.closest('.shop-item-row');
        if (!itemRow) return;

        // ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î: ‡∏ã‡πà‡∏≠‡∏ô display mode, ‡πÅ‡∏™‡∏î‡∏á edit mode
        const displayMode = itemRow.querySelector('.item-display-mode');
        const editMode = itemRow.querySelector('.item-edit-mode');
        if (displayMode && editMode) {
            displayMode.classList.add('hidden');
            editMode.classList.remove('hidden');
            // Focus ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            const quantityInput = editMode.querySelector('.edit-quantity-inline');
            quantityInput?.focus();
            quantityInput?.select();
        } else {
            console.error("Could not find display/edit mode divs in item row");
        }
    }

    /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å) ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Inline */
    function handleSaveEditInline(event) {
        const saveButton = event.target.closest('.save-edit-inline-btn');
        if (!saveButton) return;

        const itemRow = saveButton.closest('.shop-item-row');
        const editMode = saveButton.closest('.item-edit-mode');
        const displayMode = itemRow?.querySelector('.item-display-mode');
        if (!itemRow || !editMode || !displayMode) return;

        const shopId = itemRow.dataset.shopId;
        const itemIndex = parseInt(itemRow.dataset.itemIndex, 10);

        const editQuantityInput = editMode.querySelector('.edit-quantity-inline');
        const editUnitInput = editMode.querySelector('.edit-unit-inline');

        if (shopId === undefined || isNaN(itemIndex) || !editQuantityInput || !editUnitInput) {
            console.error("Cannot find elements or data for saving inline edit");
            return;
        }

        const newQuantity = editQuantityInput.value.trim();
        const newUnit = editUnitInput.value.trim() || '?';

        // Validation (‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)
        if (!newQuantity) {
            alert("‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏∞");
            editQuantityInput.focus();
            return;
        }

        // ‡∏´‡∏≤ item ‡πÉ‡∏ô state
        const shop = shops.find(s => s.id === shopId);
        if (!shop || !shop.items || itemIndex < 0 || itemIndex >= shop.items.length) {
            console.error("Cannot find item in state to save edit:", shopId, itemIndex);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
            // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
            handleCancelEditInline(event); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å cancel ‡πÅ‡∏ó‡∏ô
            return;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state
        shop.items[itemIndex].quantity = newQuantity;
        shop.items[itemIndex].unit = newUnit;
        console.log(`Item ${itemIndex} updated in shop ${shopId}:`, shop.items[itemIndex]);
        // TODO: Save state

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô display mode
        const quantitySpan = displayMode.querySelector('.item-quantity');
        const unitSpan = displayMode.querySelector('.item-unit');
        if (quantitySpan) quantitySpan.textContent = newQuantity;
        if (unitSpan) unitSpan.textContent = newUnit;

        // ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö
        editMode.classList.add('hidden');
        displayMode.classList.remove('hidden');
    }

    /** V18: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (X) ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Inline */
    function handleCancelEditInline(event) {
        const cancelButton = event.target.closest('.cancel-edit-inline-btn');
        if (!cancelButton) return;

        const itemRow = cancelButton.closest('.shop-item-row');
        const editMode = cancelButton.closest('.item-edit-mode');
        const displayMode = itemRow?.querySelector('.item-display-mode');

        if (itemRow && editMode && displayMode) {
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö state ‡πÅ‡∏Ñ‡πà‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö
            editMode.classList.add('hidden');
            displayMode.classList.remove('hidden');
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reset ‡∏Ñ‡πà‡∏≤ input ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Edit ‡πÉ‡∏´‡∏°‡πà ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å state ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        }
    }


    // --- Core Logic Functions ---
    function updateOverallSummaryButtonVisibility() { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        const shopSectionsExist = shops.length > 0; if (overallSummaryContainer) { overallSummaryContainer.style.display = shopSectionsExist ? 'block' : 'none'; }
    }
    /** V18: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å State Array ('shops') ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17) */
    function getOrderData(shopId = null) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V17) */
        if (shopId) { const shop = shops.find(s => s.id === shopId); if (shop) { return [{ shopId: shop.id, shopName: shop.name, items: [...shop.items] }]; } else { return []; } } else { return shops.filter(shop => shop.items.length > 0 || shop.name !== '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠)').map(shop => ({ shopId: shop.id, shopName: shop.name, items: [...shop.items] })); }
    }
    function formatThaiTimestamp() { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        const now = new Date(); const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', timeZone: 'Asia/Bangkok' }; const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Bangkok' }; try { const yearFormatter = new Intl.DateTimeFormat('th-TH-u-ca-buddhist', { year: 'numeric', timeZone: 'Asia/Bangkok' }); const buddhistYear = yearFormatter.format(now); const formattedDate = now.toLocaleDateString('th-TH', dateOptions).replace(/\d{4}/, buddhistYear); const formattedTime = now.toLocaleTimeString('th-TH', timeOptions); return `‡∏™‡∏£‡∏∏‡∏õ ‡∏ì ${formattedDate} ‡πÄ‡∏ß‡∏•‡∏≤ ${formattedTime} ‡∏ô.`; } catch (e) { console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:", e); return `‡∏™‡∏£‡∏∏‡∏õ ‡∏ì ${now.toLocaleString('th-TH')}`; }
    }
    function escapeHtml(unsafe) { /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        if (typeof unsafe !== 'string') return ''; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    /** V18: ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏£‡∏∏‡∏õ (‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö Read-Only) */
    function showSummary(shopId = null) {
        console.log("showSummary called for shopId:", shopId);
        if (!summaryModal || !summaryContent || !summaryTimestampElem || !modalActionsDiv) {
            console.error("showSummary: Missing required modal elements"); return;
        }

        summaryModalShopId = shopId; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô Copy

        const overallTimestamp = formatThaiTimestamp();
        summaryTimestampElem.textContent = overallTimestamp;

        const data = getOrderData(summaryModalShopId);
        summaryContent.innerHTML = '';
        if (copyStatus) copyStatus.style.display = 'none';

        // V18: ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏° Save Changes ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
        document.getElementById(SAVE_CHANGES_BTN_ID)?.remove();

        const dataToShow = data;
        if (dataToShow.length === 0) {
             summaryContent.innerHTML = '<p style="text-align: center; color: grey; margin-top: 1rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡πà‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>';
        } else {
            let modalHtml = '';
            dataToShow.forEach(shopData => {
                const currentShopId = shopData.shopId;
                if (!currentShopId) { console.error("Shop data missing ID in showSummary:", shopData); return; }

                const shopNameEscaped = escapeHtml(shopData.shopName);
                modalHtml += `<h3 style="/*...*/">üõí ${shopNameEscaped}</h3>`;

                if (summaryModalShopId === null) { /* ... timestamp ... */
                    const timePart = overallTimestamp.split(' ‡πÄ‡∏ß‡∏•‡∏≤ ')[1] || ''; const datePart = overallTimestamp.split(' ‡πÄ‡∏ß‡∏•‡∏≤ ')[0].replace('‡∏™‡∏£‡∏∏‡∏õ ‡∏ì ',''); modalHtml += `<p class="shop-timestamp-print" style="/*...*/">(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ${datePart} ${timePart})</p>`;
                }

                // V18: ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö Read-Only (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£")
                modalHtml += `
                    <table class="summary-table" data-shop-id="${currentShopId}" style="/*...*/">
                        <thead>
                            <tr>
                                <th style="/*...*/ width: 15%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th style="/*...*/ width: 20%;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                <th style="/*...*/ width: 65%;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // V18: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÅ‡∏ö‡∏ö Read-Only
                if (shopData.items && shopData.items.length > 0) {
                    shopData.items.forEach((item, index) => {
                        modalHtml += `
                            <tr>
                                <td style="/*...*/ text-align: center;">${escapeHtml(item.quantity)}</td>
                                <td style="/*...*/">${escapeHtml(item.unit)}</td>
                                <td style="/*...*/ word-wrap: break-word;">${escapeHtml(item.item)}</td>
                            </tr>
                        `; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡∏ô‡∏µ‡πâ
                    });
                } else {
                     modalHtml += `<tr><td colspan="3" style="/*...*/">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</td></tr>`; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                }
                modalHtml += `</tbody></table>`;
            });
            summaryContent.innerHTML = modalHtml;
        }
        summaryModal.style.display = 'block';
    }

    /** V18: ‡∏õ‡∏¥‡∏î Modal */
    function closeModal() {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ unsaved changes ‡πÅ‡∏•‡πâ‡∏ß)
        if (summaryModal) summaryModal.style.display = 'none';
        summaryModalShopId = null;
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏° Save ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß
    }

    /** V18: ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ */
    function copySummaryToClipboard() {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V17 - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ unsaved changes)
        if (!summaryContent) return; let textToCopy = ""; const currentTimestamp = formatThaiTimestamp(); textToCopy += currentTimestamp + "\n\n"; const dataToCopy = getOrderData(summaryModalShopId); if(dataToCopy.length === 0) { textToCopy += "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)"; } else { dataToCopy.forEach((shopData, index) => { const shopNameOnly = shopData.shopName.replace(/üõí\s*/, ''); textToCopy += `--- ${shopNameOnly} ---\n`; if (shopData.items.length > 0) { shopData.items.forEach(item => { textToCopy += `${item.quantity} ${item.unit} : ${item.item}\n`; }); } else { textToCopy += "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)\n"; } if (index < dataToCopy.length - 1) { textToCopy += "\n"; } }); } if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(textToCopy.trim()).then(() => { if (copyStatus) { copyStatus.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!'; copyStatus.style.color = '#059669'; copyStatus.style.display = 'block'; setTimeout(() => { copyStatus.style.display = 'none'; }, 2500); } }).catch(err => { console.error('Clipboard copy failed:', err); alert('‡∏≠‡∏∏‡πä‡∏õ‡∏™‡πå! ‡∏Å‡πä‡∏≠‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡∏¥‡πä'); }); } else { alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥'); }
    }

    // --- V18: ‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Modal Editing ‡∏≠‡∏≠‡∏Å ---
    // function handleDeleteItemInSummary(event) { /* ... ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å ... */ }
    // function handleSaveChangesInSummary() { /* ... ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å ... */ }
    // function handleSummaryInputChange(event) { /* ... ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å ... */ }


    // --- Initialization Function ---
    /** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ */
    async function initializeApp() {
        console.log("--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô initializeApp (V18) ---");
        if (!loadingErrorDiv) { console.error("‡∏´‡∏≤ #loading-error-message ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠!"); return; }
        loadingErrorDiv.textContent = '‚è≥ ‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á...'; loadingErrorDiv.style.display = 'block'; /* ... styling ... */
        let fetchSuccess = false;
        try {
            const response = await fetch(ITEMS_JSON_PATH, { cache: 'no-cache' }); if (!response.ok) { console.error(`Failed to fetch ${ITEMS_JSON_PATH}: ${response.status} ${response.statusText}`); let errorBody = ''; try { errorBody = await response.text(); } catch (e) {} throw new Error(`‡πÇ‡∏´‡∏•‡∏î ${ITEMS_JSON_PATH} ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (${response.status}) ${errorBody}`); } const jsonData = await response.json(); if (!Array.isArray(jsonData)) throw new Error(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô ${ITEMS_JSON_PATH} ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array`); masterItemList = jsonData; fetchSuccess = true; loadingErrorDiv.textContent = `‚úÖ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á ${masterItemList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`; /* ... styling ... */ setTimeout(() => { loadingErrorDiv.style.display = 'none'; }, 3000); createOrUpdateDatalist(GLOBAL_ITEMS_DATALIST_ID, masterItemList);
        } catch (error) {
            console.error('!!! ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î items.json:', error); loadingErrorDiv.textContent = `‚ùå ‡πÇ‡∏ó‡∏©‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (${error.message}) ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ó‡∏ô‡∏ô‡∏∞`; /* ... styling ... */ loadingErrorDiv.style.display = 'block'; shops = JSON.parse(JSON.stringify(initialShopsData)); console.warn("‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å fetch ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        } finally {
            createOrUpdateDatalist(GLOBAL_UNITS_DATALIST_ID, BASE_UNITS);
            // V18: ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ initial shops ‡∏ñ‡πâ‡∏≤ shops ‡∏ß‡πà‡∏≤‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V17.2)
            if (shops.length === 0) {
                console.warn("Shops array is empty after init attempt, using initial data.");
                shops = JSON.parse(JSON.stringify(initialShopsData));
            }
            if (shops.length > 0 && !activeShopId) { activeShopId = shops[0].id; }
            else if (shops.length === 0) { activeShopId = null; }
            renderTabs(); renderTabContent();
            setupEventListeners(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å setup listeners
            console.log("--- initializeApp ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (V18) ---");
        }
    }

    /** V18: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners ‡∏´‡∏•‡∏±‡∏Å */
    function setupEventListeners() {
        console.log("Setting up event listeners...");

        // --- Listeners ‡∏à‡∏≤‡∏Å V17 ---
        addTabButton?.addEventListener('click', handleAddTabClick);
        cancelNewShopButton?.addEventListener('click', handleCancelNewShop);
        saveNewShopButton?.addEventListener('click', handleSaveNewShop);
        newShopNameInput?.addEventListener('keypress', (event) => { if (event.key === 'Enter') { handleSaveNewShop(); } });
        overallSummaryButton?.addEventListener('click', () => showSummary());
        modalCloseButton?.addEventListener('click', closeModal);
        copySummaryButton?.addEventListener('click', copySummaryToClipboard);
        closeModalActionButton?.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => { if (event.target == summaryModal) closeModal(); });
        shopTabsContainer?.addEventListener('click', handleTabClick); // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏ö
        shopTabsContainer?.addEventListener('click', handleDeleteShopClick); // ‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏ö (X ‡∏ö‡∏ô‡πÅ‡∏ó‡πá‡∏ö)
        tabContentArea?.addEventListener('click', handleAddItemClick); // ‡πÄ‡∏û‡∏¥‡πà‡∏° item (+)
        tabContentArea?.addEventListener('keypress', (event) => { // Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á item = ‡πÄ‡∏û‡∏¥‡πà‡∏°
             if (event.key === 'Enter' && event.target.classList.contains('entry-item')) {
                 event.preventDefault(); const entryArea = event.target.closest('.item-entry-area');
                 const addButton = entryArea?.querySelector('.entry-add-btn'); addButton?.click();
             }
         });
        tabContentArea?.addEventListener('click', handleDeleteItemInline); // ‡∏•‡∏ö item inline (‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞)

        // --- V18: Listeners ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Inline Editing ---
        tabContentArea?.addEventListener('click', handleEditItemInline); // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Edit (‡∏î‡∏¥‡∏ô‡∏™‡∏≠)
        tabContentArea?.addEventListener('click', handleSaveEditInline); // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Save (‡∏ñ‡∏π‡∏Å)
        tabContentArea?.addEventListener('click', handleCancelEditInline); // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Cancel (X)

        // --- V18: ‡∏•‡∏ö Listeners ‡∏Ç‡∏≠‡∏á Modal Editing ‡∏≠‡∏≠‡∏Å ---
        // summaryContent?.addEventListener('click', handleDeleteItemInSummary); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
        // summaryContent?.addEventListener('input', handleSummaryInputChange); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
        // modalActionsDiv?.addEventListener('click', (event) => { // ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô Save ‡∏≠‡∏≠‡∏Å
        //     if (event.target.id === SAVE_CHANGES_BTN_ID || event.target.closest(`#${SAVE_CHANGES_BTN_ID}`)) {
        //         handleSaveChangesInSummary();
        //     }
        // });

         console.log("Event listeners setup complete.");
    }

    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
    initializeApp();

}); // ‡∏õ‡∏¥‡∏î DOMContentLoaded listener
