'use strict';

document.addEventListener('DOMContentLoaded', () => {

    // --- Element References ---
    // ‡∏î‡∏∂‡∏á Element ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
    const loadingErrorDiv = document.getElementById('loading-error-message');
    const shopTabsContainer = document.getElementById('shop-tabs-container'); // V15: Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö
    const addTabButton = document.getElementById('add-tab-btn'); // V15: ‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö
    const newShopInputContainer = document.getElementById('new-shop-input-container'); // V15: Div ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    const newShopNameInput = document.getElementById('new-shop-name-input'); // V15: Input ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    const saveNewShopButton = document.getElementById('save-new-shop-btn'); // V15: ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    const cancelNewShopButton = document.getElementById('cancel-new-shop-btn'); // V15: ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    const tabContentArea = document.getElementById('tab-content-area'); // V15: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö
    const noShopPlaceholder = document.getElementById('no-shop-placeholder'); // V15: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    const overallSummaryContainer = document.getElementById('overall-summary-container');
    const overallSummaryButton = document.getElementById('overall-summary-btn');
    const summaryModal = document.getElementById('summaryModal');
    const summaryContent = document.getElementById('summaryContent');
    const summaryTimestampElem = document.getElementById('summary-timestamp');
    const copyStatus = document.getElementById('copy-status');
    const modalCloseButton = document.getElementById('modal-close-btn');
    const copySummaryButton = document.getElementById('copy-summary-btn');
    const closeModalActionButton = document.getElementById('close-modal-action-btn');

    // --- Constants ---
    const BASE_UNITS = ["‡∏Å‡∏Å.", "‡∏Å‡∏£‡∏±‡∏°", "‡∏Ç‡∏µ‡∏î", "‡∏Å‡∏•‡πà‡∏≠‡∏á", "‡∏Å‡∏≥", "‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á", "‡∏Ç‡∏ß‡∏î", "‡∏Ç‡∏∂‡πâ‡∏ô‡∏â‡πà‡∏≤‡∏¢", "‡∏ä‡∏∏‡∏î", "‡∏ä‡∏¥‡πâ‡∏ô", "‡∏ä‡πà‡∏≠", "‡∏ã‡∏≠‡∏á", "‡∏ï‡πâ‡∏ô", "‡∏ñ‡∏∏‡∏á", "‡πÅ‡∏ú‡πà‡∏ô", "‡πÅ‡∏ú‡∏á", "‡πÅ‡∏ñ‡∏ß", "‡∏ú‡∏•", "‡πÉ‡∏ö", "‡∏õ‡∏µ‡πä‡∏ö", "‡∏û‡∏ß‡∏á", "‡πÅ‡∏û‡πá‡∏Ñ", "‡∏ü‡∏≠‡∏á", "‡∏°‡πâ‡∏ß‡∏ô", "‡∏°‡∏±‡∏î", "‡πÄ‡∏°‡∏ï‡∏£", "‡∏•‡∏±‡∏á", "‡∏•‡∏π‡∏Å", "‡πÄ‡∏™‡πâ‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢", "‡∏≠‡∏±‡∏ô", "‡∏´‡∏±‡∏ß", "‡∏´‡∏ß‡∏µ", "‡πÇ‡∏´‡∏•"].sort((a, b) => a.localeCompare(b, 'th'));
    const GLOBAL_ITEMS_DATALIST_ID = 'global-items-list';
    const GLOBAL_UNITS_DATALIST_ID = 'global-units-list';
    const ITEMS_JSON_PATH = 'items.json';

    // --- State Variables ---
    let masterItemList = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let shops = []; // V15: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î [{ id, name, items: [...] }, ...]
    let activeShopId = null; // V15: ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà active)

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î JSON ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
    const initialShopsData = [
        // { id: 'shop-init-1', name: '‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 1', items: [] }, // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
    ];

    // --- V15: Rendering Functions ---
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô State

    /** V15: ‡∏ß‡∏≤‡∏î‡πÅ‡∏ñ‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    function renderTabs() {
        if (!shopTabsContainer || !addTabButton) return;

        // ‡πÄ‡∏Å‡πá‡∏ö element ‡∏ó‡∏µ‡πà focus ‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const previouslyFocusedElement = document.activeElement;

        // --- ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏õ‡∏∏‡πà‡∏° + ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà) ---
        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤ element ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏∏‡πà‡∏° + ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà container ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á
        Array.from(shopTabsContainer.children).forEach(child => {
            if (child !== addTabButton && child !== newShopInputContainer) {
                shopTabsContainer.removeChild(child);
            }
        });

        // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å state 'shops' ---
        shops.forEach(shop => {
            const tabButton = document.createElement('button');
            tabButton.className = 'tab-button'; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î class
            tabButton.textContent = shop.name; // ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
            tabButton.dataset.shopId = shop.id; // ‡πÄ‡∏Å‡πá‡∏ö shop ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô data attribute
            if (shop.id === activeShopId) {
                tabButton.classList.add('active'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° class 'active' ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà
            }
            // ‡πÉ‡∏™‡πà event listener ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ó‡πá‡∏ö (‡πÉ‡∏ä‡πâ handleTabClick)
            tabButton.addEventListener('click', handleTabClick);
            // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏° +
            shopTabsContainer.insertBefore(tabButton, addTabButton);
        });

        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ focus ‡πÑ‡∏õ‡∏ó‡∏µ‡πà element ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ)
        if (previouslyFocusedElement && document.body.contains(previouslyFocusedElement)) {
             // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ element ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô DOM ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞ focus
             try {
                 previouslyFocusedElement.focus();
             } catch (e) {
                 // console.warn("Could not restore focus:", e);
             }
        } else if (activeShopId) {
             // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ focus ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏°‡∏µ active tab ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á focus ‡∏ó‡∏µ‡πà active tab
             const activeTabButton = shopTabsContainer.querySelector(`.tab-button[data-shop-id="${activeShopId}"]`);
             activeTabButton?.focus();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        updateOverallSummaryButtonVisibility();
    }

    /** V15: ‡∏ß‡∏≤‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    function renderTabContent() {
        if (!tabContentArea) return;
        tabContentArea.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏Å‡πà‡∏≤

        // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà active ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å state 'shops'
        const activeShop = shops.find(shop => shop.id === activeShopId);

        if (activeShop) { // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà active ‡∏≠‡∏¢‡∏π‡πà
            // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á Header (‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö) ---
            const headerDiv = document.createElement('div');
            headerDiv.className = 'shop-header'; // ‡πÉ‡∏ä‡πâ class ‡πÄ‡∏î‡∏¥‡∏°

            // V15: ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô text ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
            const shopNameDisplay = document.createElement('span');
            shopNameDisplay.className = 'shop-name-display';
            shopNameDisplay.textContent = activeShop.name;

            const deleteShopBtn = document.createElement('button');
            deleteShopBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>`;
            deleteShopBtn.className = 'delete-shop-btn';
            deleteShopBtn.title = "‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ";
            deleteShopBtn.type = "button";
            deleteShopBtn.dataset.shopId = activeShop.id; // ‡πÉ‡∏™‡πà shopId ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏ö
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÉ‡∏ä‡πâ handleDeleteShopClick)
            deleteShopBtn.addEventListener('click', handleDeleteShopClick);

            headerDiv.appendChild(shopNameDisplay);
            headerDiv.appendChild(deleteShopBtn);
            tabContentArea.appendChild(headerDiv);

            // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á Item Entry Area ---
            const entryArea = createItemEntryArea(activeShop.id);
            tabContentArea.appendChild(entryArea);

             // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á Action Buttons (‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ) ---
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'shop-actions';

            const summarizeBtn = document.createElement('button');
            summarizeBtn.textContent = 'üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ';
            summarizeBtn.className = 'action-button summarize-btn';
            summarizeBtn.type = "button";
            // ‡∏™‡πà‡∏á activeShopId ‡πÑ‡∏õ‡πÉ‡∏´‡πâ showSummary
            summarizeBtn.addEventListener('click', () => showSummary(activeShopId));

            buttonsDiv.appendChild(summarizeBtn);
            tabContentArea.appendChild(buttonsDiv);

            // ‡∏ã‡πà‡∏≠‡∏ô placeholder ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
            if(noShopPlaceholder) noShopPlaceholder.style.display = 'none';

        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ active (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏õ)
            // ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á placeholder
            if(noShopPlaceholder) noShopPlaceholder.style.display = 'block';
        }
    }

    // --- V15: UI Creation Functions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏ö‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á) ---

    /** ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Global Datalist */
    function createOrUpdateDatalist(listId, optionsArray) {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14)
        let datalist = document.getElementById(listId);
        if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = listId;
            document.body.appendChild(datalist);
            datalist = document.getElementById(listId);
            if (!datalist) { console.error(`!!! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏´‡∏≤ datalist ID: ${listId} ‡πÑ‡∏î‡πâ!`); return; }
        }
        datalist.innerHTML = '';
        if (!Array.isArray(optionsArray)) { console.error(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö datalist ID: ${listId} ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array!`); return; }
        const sortedOptions = [...optionsArray].sort((a, b) => a.localeCompare(b, 'th'));
        sortedOptions.forEach(optionValue => {
            if (typeof optionValue === 'string' && optionValue.trim() !== '') {
                try {
                    const option = document.createElement('option'); option.value = optionValue; datalist.appendChild(option);
                } catch (e) { console.error(`‡πÄ‡∏Å‡∏¥‡∏î Error ‡∏ï‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° option "${optionValue}" ‡πÉ‡∏ô datalist ID: ${listId}`, e); }
            }
        });
    }

    /** ‡∏™‡∏£‡πâ‡∏≤‡∏á Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Entry Area) */
    function createUnitInputEntry(selectedUnit = '') {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14)
        const input = document.createElement('input');
        input.type = 'text'; input.placeholder = '‡∏´‡∏ô‡πà‡∏ß‡∏¢'; input.className = 'entry-unit';
        input.value = selectedUnit; input.setAttribute('list', GLOBAL_UNITS_DATALIST_ID); return input;
    }

    /** ‡∏™‡∏£‡πâ‡∏≤‡∏á Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Entry Area) */
    function createItemInputEntry(selectedItem = '') {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14)
        const input = document.createElement('input');
        input.type = 'text'; input.placeholder = '‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°...'; input.className = 'entry-item';
        input.value = selectedItem; input.setAttribute('list', GLOBAL_ITEMS_DATALIST_ID); return input;
    }

    /** V15: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Entry Area) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô */
    function createItemEntryArea(shopId) {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14)
        const entryDiv = document.createElement('div');
        entryDiv.className = 'item-entry-area'; entryDiv.dataset.shopId = shopId;
        const quantityInput = document.createElement('input');
        quantityInput.type = 'number'; quantityInput.placeholder = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'; quantityInput.min = "0";
        quantityInput.step = "any"; quantityInput.className = 'entry-quantity';
        const unitInput = createUnitInputEntry(); const itemInput = createItemInputEntry();
        const addBtn = document.createElement('button');
        addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>`;
        addBtn.className = 'action-button entry-add-btn'; addBtn.title = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ"; addBtn.type = "button";
        const statusDiv = document.createElement('div'); statusDiv.className = 'entry-status';
        entryDiv.appendChild(quantityInput); entryDiv.appendChild(unitInput); entryDiv.appendChild(itemInput);
        entryDiv.appendChild(addBtn); entryDiv.appendChild(statusDiv);
        return entryDiv;
    }

    // --- V15: Event Handlers ---
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î Event ‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ input)

    /** V15: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ */
    function handleTabClick(event) {
        const clickedTab = event.target.closest('.tab-button'); // ‡∏´‡∏≤ element ‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
        if (!clickedTab || clickedTab.classList.contains('active')) {
            return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ó‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà active ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
        }
        const newActiveShopId = clickedTab.dataset.shopId; // ‡∏î‡∏∂‡∏á shopId ‡∏à‡∏≤‡∏Å data attribute
        if (newActiveShopId) {
            activeShopId = newActiveShopId; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state activeShopId
            renderTabs(); // ‡∏ß‡∏≤‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô active class)
            renderTabContent(); // ‡∏ß‡∏≤‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
        }
    }

    /** V15: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà */
    function handleAddTabClick() {
        if (newShopInputContainer && addTabButton && newShopNameInput) {
            newShopInputContainer.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠
            addTabButton.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° +
            newShopNameInput.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤
            newShopNameInput.focus(); // ‡∏¢‡πâ‡∏≤‡∏¢ cursor ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
        }
    }

    /** V15: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà */
    function handleCancelNewShop() {
         if (newShopInputContainer && addTabButton) {
            newShopInputContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
            addTabButton.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° + ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            newShopNameInput.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
        }
    }

    /** V15: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà */
    function handleSaveNewShop() {
        if (!newShopNameInput) return;
        const newName = newShopNameInput.value.trim(); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà

        if (!newName) {
            alert("‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏ô‡∏∞"); // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠
            newShopNameInput.focus();
            return;
        }
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≥ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
        if (shops.some(shop => shop.name.toLowerCase() === newName.toLowerCase())) {
             alert(`‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠ "${newName}" ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞`);
             newShopNameInput.focus();
             newShopNameInput.select();
             return;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        const newShopId = `shop-${Date.now()}`;
        const newShopData = { id: newShopId, name: newName, items: [] };
        shops.push(newShopData); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ state 'shops'

        activeShopId = newShopId; // ‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô active ‡πÄ‡∏•‡∏¢

        renderTabs(); // ‡∏ß‡∏≤‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
        renderTabContent(); // ‡∏ß‡∏≤‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà

        handleCancelNewShop(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° +

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á localStorage ‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
    }

     /** V15: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô (X) */
    function handleDeleteShopClick(event) {
        const deleteButton = event.target.closest('.delete-shop-btn');
        if (!deleteButton) return;

        const shopIdToDelete = deleteButton.dataset.shopId;
        const shopToDelete = shops.find(s => s.id === shopIdToDelete);

        if (!shopToDelete) return;

        // ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        if (confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏∞‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô "${shopToDelete.name}" ‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏¥? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏´‡∏°‡∏î‡∏ô‡∏∞!`)) {
            const indexToDelete = shops.findIndex(s => s.id === shopIdToDelete);
            if (indexToDelete > -1) {
                // ‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å state
                shops.splice(indexToDelete, 1);

                // --- ‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞ active ‡∏ï‡πà‡∏≠‡πÑ‡∏õ ---
                if (activeShopId === shopIdToDelete) { // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà active ‡∏≠‡∏¢‡∏π‡πà
                    if (shops.length === 0) { // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                        activeShopId = null;
                    } else if (indexToDelete >= shops.length) { // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                        // ‡πÉ‡∏´‡πâ active ‡∏≠‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
                        activeShopId = shops[shops.length - 1].id;
                    } else { // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å
                        // ‡πÉ‡∏´‡πâ active ‡∏≠‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏õ)
                        activeShopId = shops[indexToDelete].id;
                    }
                }
                // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà active ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô activeShopId

                // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
                renderTabs();
                renderTabContent();

                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á localStorage ‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
            }
        }
    }


    /** V15: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" (+) ‡πÉ‡∏ô Entry Area (‡πÉ‡∏ä‡πâ Event Delegation) */
    function handleAddItemClick(event) {
        const addButton = event.target.closest('.entry-add-btn');
        if (!addButton) return; // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°

        const entryArea = addButton.closest('.item-entry-area');
        if (!entryArea) return; // ‡∏´‡∏≤ entry area ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠

        // V15: ‡∏î‡∏∂‡∏á shopId ‡∏à‡∏≤‡∏Å entry area ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≤‡∏Å activeShopId ‡∏Å‡πá‡πÑ‡∏î‡πâ
        const shopId = entryArea.dataset.shopId; // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ activeShopId
        const quantityInput = entryArea.querySelector('.entry-quantity');
        const unitInput = entryArea.querySelector('.entry-unit');
        const itemInput = entryArea.querySelector('.entry-item');

        if (!shopId || !quantityInput || !unitInput || !itemInput) {
            console.error("‡∏´‡∏≤ elements ‡πÉ‡∏ô entry area ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏£‡πâ‡∏≤‡∏ô:", shopId);
            return;
        }

        const quantity = quantityInput.value.trim();
        const unit = unitInput.value.trim();
        const itemName = itemInput.value.trim();
        const itemNameLower = itemName.toLowerCase();

        // --- Validation ---
        if (!itemName) {
            showEntryStatus(entryArea, '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô!', true);
            itemInput.focus(); return;
        }
        if (!quantity) {
            showEntryStatus(entryArea, '‚ö†Ô∏è ‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤?', true);
            quantityInput.focus(); return;
        }

        // --- Find shop in state ---
        const shop = shops.find(s => s.id === shopId);
        if (!shop) {
            console.error("‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô state ID:", shopId);
            showEntryStatus(entryArea, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ', true); return;
        }

        // --- Duplicate Check ---
        const isDuplicate = shop.items.some(item => item.item.toLowerCase() === itemNameLower);
        if (isDuplicate) {
            showEntryStatus(entryArea, `‚ö†Ô∏è "${itemName}" ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!`, true);
            itemInput.focus(); itemInput.select(); return; // ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á
        }

        // --- Add item to state ---
        shop.items.push({ quantity: quantity, unit: unit || '?', item: itemName });

        // --- Success Feedback & Clear Inputs ---
        showEntryStatus(entryArea, `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° "${itemName}" ‡πÅ‡∏•‡πâ‡∏ß!`, false);
        quantityInput.value = ''; unitInput.value = ''; itemInput.value = '';
        itemInput.focus(); // Focus ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á item ‡∏£‡∏≠‡πÉ‡∏™‡πà‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ

        // TODO: Save state if implementing persistence
        // console.log("Updated shop state:", shop);
    }

    /** V15: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏ã‡πâ‡∏≥ ‡πÉ‡∏ô Entry Area */
    function showEntryStatus(entryAreaElement, message, isError = false) {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14)
        const statusDiv = entryAreaElement.querySelector('.entry-status');
        if (!statusDiv) return;
        statusDiv.textContent = message;
        statusDiv.className = `entry-status ${isError ? 'error' : 'success'}`;
        statusDiv.style.display = 'block';
        setTimeout(() => {
            statusDiv.style.display = 'none'; statusDiv.textContent = ''; statusDiv.className = 'entry-status';
        }, 2500);
    }

    // --- Core Logic Functions (‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà getOrderData ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å State) ---

    /** ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    function updateOverallSummaryButtonVisibility() {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14)
        const shopSectionsExist = shops.length > 0;
        if (overallSummaryContainer) {
            overallSummaryContainer.style.display = shopSectionsExist ? 'block' : 'none';
        }
    }

    /** V15: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å State Array ('shops') ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ */
    function getOrderData(shopId = null) {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14)
        if (shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (shop) { return [{ shopName: shop.name, items: [...shop.items] }]; }
            else { return []; }
        } else {
             return shops
                .filter(shop => shop.items.length > 0 || shop.name !== '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠)')
                .map(shop => ({ shopName: shop.name, items: [...shop.items] }));
        }
    }

    /** ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ */
    function formatThaiTimestamp() {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V12)
        const now = new Date();
        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', timeZone: 'Asia/Bangkok' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Bangkok' };
        try {
            const yearFormatter = new Intl.DateTimeFormat('th-TH-u-ca-buddhist', { year: 'numeric', timeZone: 'Asia/Bangkok' });
            const buddhistYear = yearFormatter.format(now);
            const formattedDate = now.toLocaleDateString('th-TH', dateOptions).replace(/\d{4}/, buddhistYear);
            const formattedTime = now.toLocaleTimeString('th-TH', timeOptions);
            return `‡∏™‡∏£‡∏∏‡∏õ ‡∏ì ${formattedDate} ‡πÄ‡∏ß‡∏•‡∏≤ ${formattedTime} ‡∏ô.`;
        } catch (e) { console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:", e); return `‡∏™‡∏£‡∏∏‡∏õ ‡∏ì ${now.toLocaleString('th-TH')}`; }
    }

    /** Escape HTML special characters */
    function escapeHtml(unsafe) {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        if (typeof unsafe !== 'string') return '';
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    /** V15: ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏£‡∏∏‡∏õ (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V12/V14) */
    function showSummary(shopId = null) {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V12/V14)
        if (!summaryModal || !summaryContent || !summaryTimestampElem) { console.error("‡∏´‡∏≤ Element ‡∏Ç‡∏≠‡∏á Modal ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠!"); return; }
        const overallTimestamp = formatThaiTimestamp();
        summaryTimestampElem.textContent = overallTimestamp;
        const data = getOrderData(shopId); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å State
        summaryContent.innerHTML = '';
        if (copyStatus) copyStatus.style.display = 'none';
        const dataToShow = data;
        if (dataToShow.length === 0) {
             summaryContent.innerHTML = '<p style="text-align: center; color: grey; margin-top: 1rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡πà‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>';
        } else {
            let modalHtml = '';
            dataToShow.forEach(shopData => {
                const shopNameEscaped = escapeHtml(shopData.shopName);
                modalHtml += `<h3 style="font-size: 1.1rem; font-weight: 600; margin-top: 1.2rem; margin-bottom: 0.25rem; color: #1f2937; padding-bottom: 0.25rem; border-bottom: 1px solid #e5e7eb;">üõí ${shopNameEscaped}</h3>`;
                if (shopId === null) {
                    const timePart = overallTimestamp.split(' ‡πÄ‡∏ß‡∏•‡∏≤ ')[1] || '';
                    const datePart = overallTimestamp.split(' ‡πÄ‡∏ß‡∏•‡∏≤ ')[0].replace('‡∏™‡∏£‡∏∏‡∏õ ‡∏ì ','');
                    modalHtml += `<p class="shop-timestamp-print" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; text-align: left;">(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ${datePart} ${timePart})</p>`;
                }
                modalHtml += `<table style="width: 100%; border-collapse: collapse; margin-bottom: 0.5rem; font-size: 0.9rem;"><thead style="background-color: #f8f9fa;"><tr><th style="border: 1px solid #ddd; padding: 6px 8px; text-align: center; width: 15%; font-weight: 600;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th style="border: 1px solid #ddd; padding: 6px 8px; text-align: left; width: 20%; font-weight: 600;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th style="border: 1px solid #ddd; padding: 6px 8px; text-align: left; width: 45%; font-weight: 600;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="border: 1px solid #ddd; padding: 6px 8px; text-align: left; width: 20%; font-weight: 600;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr></thead><tbody>`;
                if (shopData.items && shopData.items.length > 0) {
                    shopData.items.forEach(item => {
                        modalHtml += `<tr><td style="border: 1px solid #ddd; padding: 6px 8px; text-align: center; vertical-align: top;">${escapeHtml(item.quantity)}</td><td style="border: 1px solid #ddd; padding: 6px 8px; vertical-align: top;">${escapeHtml(item.unit)}</td><td style="border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; word-wrap: break-word;">${escapeHtml(item.item)}</td><td style="border: 1px solid #ddd; padding: 6px 8px; vertical-align: top;"></td></tr>`;
                    });
                } else {
                     modalHtml += `<tr><td colspan="4" style="text-align: center; font-style: italic; color: grey; border: 1px solid #ddd; padding: 6px 8px;">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</td></tr>`;
                }
                modalHtml += `</tbody><tfoot style="font-weight: bold; background-color: #f8f9fa;"><tr><td colspan="3" style="border: 1px solid #ddd; border-right: none; padding: 6px 10px 6px 8px; text-align: right;">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤:</td><td style="border: 1px solid #ddd; border-left: none; padding: 6px 8px; min-height: 1.5em;"></td></tr></tfoot></table>`;
            });
            summaryContent.innerHTML = modalHtml;
        }
        summaryModal.style.display = 'block';
    }

    /** ‡∏õ‡∏¥‡∏î Modal */
    function closeModal() {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        if (summaryModal) summaryModal.style.display = 'none';
    }

    /** ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14) */
    function copySummaryToClipboard() {
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V14)
        if (!summaryContent) return; let textToCopy = ""; const currentTimestamp = formatThaiTimestamp(); textToCopy += currentTimestamp + "\n\n"; const dataToCopy = getOrderData();
         if(dataToCopy.length === 0) { textToCopy += "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)"; }
         else {
             dataToCopy.forEach((shopData, index) => {
                const shopNameOnly = shopData.shopName.replace(/üõí\s*/, ''); textToCopy += `--- ${shopNameOnly} ---\n`;
                if (shopData.items.length > 0) { shopData.items.forEach(item => { textToCopy += `${item.quantity} ${item.unit} : ${item.item}\n`; }); }
                else { textToCopy += "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)\n"; }
                if (index < dataToCopy.length - 1) { textToCopy += "\n"; }
            });
         }
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy.trim()).then(() => { if (copyStatus) { copyStatus.style.display = 'block'; setTimeout(() => { copyStatus.style.display = 'none'; }, 2500); } }).catch(err => { console.error('Clipboard copy failed:', err); alert('‡∏≠‡∏∏‡πä‡∏õ‡∏™‡πå! ‡∏Å‡πä‡∏≠‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡∏¥‡πä'); });
        } else { alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥'); }
    }

    // --- Initialization Function ---
    /** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ */
    async function initializeApp() {
        console.log("--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô initializeApp (V15) ---");
        if (!loadingErrorDiv) { console.error("‡∏´‡∏≤ #loading-error-message ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠!"); return; }
        loadingErrorDiv.textContent = '‚è≥ ‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á...';
        loadingErrorDiv.style.display = 'block'; /* ... styling ... */

        let fetchSuccess = false;
        try {
            // --- ‡πÇ‡∏´‡∏•‡∏î Master Item List ---
            const response = await fetch(ITEMS_JSON_PATH, { cache: 'no-cache' });
            if (!response.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î ${ITEMS_JSON_PATH} ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (${response.status})`);
            const jsonData = await response.json();
            if (!Array.isArray(jsonData)) throw new Error(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô ${ITEMS_JSON_PATH} ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array`);
            masterItemList = jsonData;
            fetchSuccess = true;
            loadingErrorDiv.textContent = `‚úÖ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á ${masterItemList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`; /* ... styling ... */
            setTimeout(() => { loadingErrorDiv.style.display = 'none'; }, 3000);
            createOrUpdateDatalist(GLOBAL_ITEMS_DATALIST_ID, masterItemList);
        } catch (error) {
            console.error('!!! ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î items.json:', error);
            loadingErrorDiv.textContent = `‚ùå ‡πÇ‡∏ó‡∏©‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (${error.message}) ...`; /* ... styling ... */
            loadingErrorDiv.style.display = 'block';
            // V15: ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
            shops = JSON.parse(JSON.stringify(initialShopsData)); // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            console.warn("‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ó‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)");
        } finally {
            // --- Setup ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ---
            createOrUpdateDatalist(GLOBAL_UNITS_DATALIST_ID, BASE_UNITS); // ‡∏™‡∏£‡πâ‡∏≤‡∏á datalist ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠

            // V15: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î active shop ‡πÅ‡∏£‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (shops.length > 0 && !activeShopId) {
                activeShopId = shops[0].id;
            } else if (shops.length === 0) {
                activeShopId = null; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏°‡∏µ active
            }

            // --- Render ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ---
            renderTabs(); // ‡∏ß‡∏≤‡∏î‡πÅ‡∏ó‡πá‡∏ö
            renderTabContent(); // ‡∏ß‡∏≤‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏£‡∏Å (‡∏´‡∏£‡∏∑‡∏≠ placeholder)

            // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners ---
            setupEventListeners();

            console.log("--- initializeApp ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (V15) ---");
        }
    }

    /** V15: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners ‡∏´‡∏•‡∏±‡∏Å */
    function setupEventListeners() {
        // ‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö/‡∏£‡πâ‡∏≤‡∏ô
        addTabButton?.addEventListener('click', handleAddTabClick);
        // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô
        cancelNewShopButton?.addEventListener('click', handleCancelNewShop);
        // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        saveNewShopButton?.addEventListener('click', handleSaveNewShop);
        // ‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà = ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        newShopNameInput?.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleSaveNewShop();
            }
        });

        // ‡∏õ‡∏∏‡πà‡∏° ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏•‡∏≠‡∏¢)
        overallSummaryButton?.addEventListener('click', () => showSummary()); // ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏∏‡∏Å‡∏£‡πâ‡∏≤‡∏ô
        // ‡∏õ‡∏∏‡πà‡∏° X ‡∏õ‡∏¥‡∏î Modal
        modalCloseButton?.addEventListener('click', closeModal);
        // ‡∏õ‡∏∏‡πà‡∏° Copy ‡πÉ‡∏ô Modal
        copySummaryButton?.addEventListener('click', copySummaryToClipboard);
        // ‡∏õ‡∏∏‡πà‡∏° ‡∏õ‡∏¥‡∏î ‡πÉ‡∏ô Modal
        closeModalActionButton?.addEventListener('click', closeModal);
        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å Modal ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î
        window.addEventListener('click', (event) => {
            if (event.target == summaryModal) closeModal();
        });

        // V15: ‡πÉ‡∏ä‡πâ Event Delegation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" (+) ‡πÉ‡∏ô Content Area
        tabContentArea?.addEventListener('click', handleAddItemClick);

        // V15: Event Delegation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô (X) ‡πÉ‡∏ô Content Area (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡πÉ‡∏ô renderTabContent)
        // tabContentArea?.addEventListener('click', handleDeleteShopClick); // ‡∏ñ‡πâ‡∏≤ listener ‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡πÉ‡∏ô renderTabContent ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ã‡πâ‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

        // V15: ‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Item Input = ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        tabContentArea?.addEventListener('keypress', (event) => {
             if (event.key === 'Enter' && event.target.classList.contains('entry-item')) {
                 event.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° Enter ‡∏õ‡∏Å‡∏ï‡∏¥
                 // ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏° Add ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÜ input ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß simulate ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å
                 const entryArea = event.target.closest('.item-entry-area');
                 const addButton = entryArea?.querySelector('.entry-add-btn');
                 addButton?.click(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å handleAddItemClick ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å
             }
         });
    }

    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
    initializeApp();

}); // ‡∏õ‡∏¥‡∏î DOMContentLoaded listener
